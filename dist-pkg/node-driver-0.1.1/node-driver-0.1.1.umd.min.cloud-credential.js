(("undefined"!==typeof self?self:this)["webpackJsonpnode_driver_0_1_1"]=("undefined"!==typeof self?self:this)["webpackJsonpnode_driver_0_1_1"]||[]).push([[1],{"0232":function(t,e,o){"use strict";o("273c")},"273c":function(t,e,o){var a=o("58f3");a.__esModule&&(a=a.default),"string"===typeof a&&(a=[[t.i,a,""]]),a.locals&&(t.exports=a.locals);var s=o("0ed3").default;s("46ece8a7",a,!0,{sourceMap:!1,shadowMode:!1})},"58f3":function(t,e,o){var a=o("3c10");e=a(!1),e.push([t.i,".allow-list-error[data-v-12789930]{display:flex}.allow-list-error[data-v-12789930]>:first-child{flex:1}",""]),t.exports=e},"9c5d":function(t,e,o){var a=o("3c10");e=a(!1),e.push([t.i,".icon-spacer[data-v-057271d0]{width:24px}",""]),t.exports=e},c990:function(t,e,o){var a=o("9c5d");a.__esModule&&(a=a.default),"string"===typeof a&&(a=[[t.i,a,""]]),a.locals&&(t.exports=a.locals);var s=o("0ed3").default;s("1d62ab36",a,!0,{sourceMap:!1,shadowMode:!1})},cd48:function(t,e,o){"use strict";o.r(e);var a=function(){var t=this,e=t._self._c;return e("div",[e("div",{staticClass:"row"},[e("div",{staticClass:"col span-6"},[e("LabeledInput",{attrs:{value:t.value.decodedData.endpoint,disabled:1!==t.step,"label-key":"driver.viarezo.auth.fields.endpoint","placeholder-key":"driver.viarezo.auth.placeholders.endpoint",type:"text",mode:t.mode},on:{input:function(e){return t.value.setData("endpoint",e)}}})],1),e("div",{staticClass:"col span-6"},[e("LabeledInput",{attrs:{value:t.value.decodedData.domainName,disabled:1!==t.step,"label-key":"driver.viarezo.auth.fields.domainName","placeholder-key":"driver.viarezo.auth.placeholders.domainName",type:"text",mode:t.mode},on:{input:function(e){return t.value.setData("domainName",e)}}})],1)]),e("div",{staticClass:"row"},[e("div",{staticClass:"col span-6"},[e("LabeledInput",{staticClass:"mt-20",attrs:{value:t.value.decodedData.username,disabled:1!==t.step,"label-key":"driver.viarezo.auth.fields.username","placeholder-key":"driver.viarezo.auth.placeholders.username",type:"text",mode:t.mode},on:{input:function(e){return t.value.setData("username",e)}}})],1),e("div",{staticClass:"col span-6"},[e("LabeledInput",{staticClass:"mt-20",attrs:{value:t.value.decodedData.password,disabled:1!==t.step,"label-key":"driver.viarezo.auth.fields.password","placeholder-key":"driver.viarezo.auth.placeholders.password",type:"password",mode:t.mode},on:{input:function(e){return t.value.setData("password",e)}}})],1)]),e("BusyButton",{ref:"connect",staticClass:"mt-20",attrs:{"label-key":"driver.viarezo.auth.actions.authenticate",disabled:1!==t.step||!t.canAuthenticate},on:{click:t.connect}}),e("button",{staticClass:"btn role-primary mt-20 ml-20",attrs:{disabled:t.busy||1===t.step},on:{click:t.clear}},[t._v(" "+t._s(t.t("driver.viarezo.auth.actions.edit"))+" ")]),t.error?e("Banner",{staticClass:"mt-20",attrs:{color:"error"}},[t._v(" "+t._s(t.error)+" ")]):t._e(),t.errorAllowHost?e("Banner",{staticClass:"allow-list-error",attrs:{color:"error"}},[e("div",[t._v(" "+t._s(t.t("driver.viarezo.auth.errors.notAllowed",{hostname:t.hostname}))+" ")]),e("button",{staticClass:"btn ml-10 role-primary",attrs:{disabled:t.allowBusy},on:{click:t.addHostToAllowList}},[t._v(" "+t._s(t.t("driver.viarezo.auth.actions.addToAllowList"))+" ")])]):t._e(),t.projects?e("div",{staticClass:"row mt-20"},[e("div",{staticClass:"col span-6"},[e("LabeledSelect",{attrs:{value:t.project,"label-key":"driver.viarezo.auth.fields.project",options:t.projectOptions,searchable:!1},on:{"update:value":e=>t.project=e}})],1),t.regions?e("div",{staticClass:"col span-6"},[e("LabeledSelect",{attrs:{value:t.region,"label-key":"driver.viarezo.auth.fields.region",options:t.regionOptions,searchable:!1},on:{"update:value":e=>t.region=e}})],1):t._e()]):t._e()],1)},s=[],i=o("eb32"),r=o("8e93"),n=o("466b");o("907c");function l(t){const e=l.options,o=e.parser[e.strictMode?"strict":"loose"].exec(t);if(!o)throw new Error("Cannot parse as uri: "+t);const a={};let s=14;while(s--)a[e.key[s]]=o[s]||"";return a.query={},a.queryStr.replace(e.q.parser,(t,o,s)=>(o&&(a[e.q.name][o]=s),"")),a}l.options={strictMode:!1,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","queryStr","anchor"],q:{name:"query",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}};var d=o("da25"),c=function(){var t=this,e=t._self._c;return e("button",{ref:"btn",staticClass:"btn role-primary",attrs:{disabled:t.disabled,"tab-index":t.tabIndex,"data-testid":t.componentTestid+"-async-button"},on:{click:t.clicked}},[t.busy?e("i",{staticClass:"icon icon-lg icon-spinner icon-spin"}):e("span",{staticClass:"icon-spacer"}),e("span",[t._v(t._s(t.displayLabel))]),e("span",{staticClass:"icon-spacer"})])},u=[],p={props:{label:{type:String,default:void 0},labelKey:{type:String,default:void 0},disabled:{type:Boolean,default:!1},tabIndex:{type:Number,default:null},componentTestid:{type:String,default:"busy-button"},manual:{type:Boolean,default:!1}},data(){return{busy:!1}},computed:{displayLabel(){if(this.labelKey){const t=this.$store.getters["i18n/t"];return t(this.labelKey)}return this.label}},methods:{clicked(t){if(t&&(t.stopPropagation(),t.preventDefault()),this.disabled)return;const e=()=>{this.busy=!1};this.busy=!0,this.$emit("click",e)},focus(){this.$refs.btn.focus()}}},h=p,v=(o("dcb6"),o("2be6")),m=Object(v["a"])(h,c,u,!1,null,"057271d0",null),y=m.exports,f=o("f2d8"),g={components:{Banner:i["a"],BusyButton:y,LabeledInput:r["a"],LabeledSelect:n["a"]},props:{mode:{type:String,required:!0},value:{type:Object,required:!0}},async fetch(){this.driver=await this.$store.dispatch("rancher/find",{type:"nodedriver",id:"viarezo"})},data(){return this.mode!==d["a"]&&(this.value.decodedData.username=this.value.annotations["viarezo.cattle.io/username"],this.value.decodedData.endpoint=this.value.annotations["viarezo.cattle.io/endpoint"]),{projects:null,regions:null,step:1,busy:!1,project:"",region:"",errorAllowHost:!1,driver:{},allowBusy:!1,error:""}},computed:{projectOptions(){const t=(this.projects||[]).sort((t,e)=>t.name.localeCompare(e.name));return t.map(t=>({label:t.name,value:t.id}))},regionOptions(){const t=(this.regions||[]).sort((t,e)=>t.name.localeCompare(e.name));return t.map(t=>({label:t.id,value:t.id}))},hostname(){const t=l(this.value.decodedData.endpoint);return(null===t||void 0===t?void 0:t.host)||""},canAuthenticate(){var t,e,o,a;return!(null===(t=this.value)||void 0===t||null===(t=t.decodedData)||void 0===t||!t.endpoint)&&!(null===(e=this.value)||void 0===e||null===(e=e.decodedData)||void 0===e||!e.domainName)&&!(null===(o=this.value)||void 0===o||null===(o=o.decodedData)||void 0===o||!o.username)&&!(null===(a=this.value)||void 0===a||null===(a=a.decodedData)||void 0===a||!a.password)}},created(){this.$emit("validationChanged",!1)},methods:{test(){this.value.annotations=this.value.annotations||{},this.value.annotations["viarezo.cattle.io/username"]=this.value.decodedData.username,this.value.annotations["viarezo.cattle.io/domainName"]=this.value.decodedData.domainName,this.value.annotations["viarezo.cattle.io/endpoint"]=this.value.decodedData.endpoint;const t=this.projects.find(t=>t.id===this.project);return t&&(this.value.annotations["viarezo.cattle.io/projectId"]=t.id),this.region&&(this.value.annotations["viarezo.cattle.io/region"]=this.region),!0},clear(){this.step=1,this.projects=null,this.errorAllowHost=!1,this.$emit("validationChanged",!1)},hostInAllowList(){var t,e;if(null===(t=this.driver)||void 0===t||!t.whitelistDomains)return!1;const o=l(this.value.decodedData.endpoint);return!o.host||((null===(e=this.driver)||void 0===e?void 0:e.whitelistDomains)||[]).includes(o.host)},async addHostToAllowList(){this.allowBusy=!0;const t=l(this.value.decodedData.endpoint);this.driver.whitelistDomains=this.driver.whitelistDomains||[],this.hostInAllowList()||this.driver.whitelistDomains.push(t.host);try{await this.driver.save(),this.$refs.connect.$el.click()}catch(e){console.error("Could not update driver",e),this.allowBusy=!1}},async connect(t){var e,o;if(t&&"function"!==typeof t)return;this.error="",this.errorAllowHost=!1;let a=!1;if(!this.value.decodedData.endpoint)return t(a);const s=new f["a"](this.$store,{endpoint:this.value.decodedData.endpoint,domainName:this.value.decodedData.domainName,username:this.value.decodedData.username,password:this.value.decodedData.password});this.allowBusy=!1,this.step=2,this.busy=!0;const i=await s.getToken();if(i.error)console.error(i.error),a=!1,this.step=1,this.projects=null,502!==i.error._status||this.hostInAllowList()?502===i.error._status?this.error=this.t("driver.viarezo.auth.errors.badGateway"):401===i.error._status?this.error=this.t("driver.viarezo.auth.errors.unauthorized"):this.error=i.error.message||this.t("driver.viarezo.auth.errors.other"):this.errorAllowHost=!0;else{const t=await s.getProjects();t.error?this.error=t.error.message:(this.projects=t,a=!0);const e=await s.getRegions();if(e.error){const t=this.projectOptions[0].value,e=this.projects.find(e=>e.id===t);if(e){const t=new f["a"](this.$store,{...s,projectName:e.name,projectId:e.id,projectDomainName:e.domain_id});await t.getToken().then(()=>{this.regions=t.regionsFromCatalog})}}else this.regions=e,a=!0}this.busy=!1,this.project=null===(e=this.projectOptions[0])||void 0===e?void 0:e.value,this.region=null===(o=this.regionOptions[0])||void 0===o?void 0:o.value,this.$emit("validationChanged",a),t(a)}}},b=g,w=(o("0232"),Object(v["a"])(b,a,s,!1,null,"12789930",null));e["default"]=w.exports},dcb6:function(t,e,o){"use strict";o("c990")},f2d8:function(t,e,o){"use strict";function a(t,e,o){return(e=s(e))in t?Object.defineProperty(t,e,{value:o,enumerable:!0,configurable:!0,writable:!0}):t[e]=o,t}function s(t){var e=i(t,"string");return"symbol"==typeof e?e:e+""}function i(t,e){if("object"!=typeof t||!t)return t;var o=t[Symbol.toPrimitive];if(void 0!==o){var a=o.call(t,e||"default");if("object"!=typeof a)return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}o.d(e,"a",(function(){return r}));class r{constructor(t,e){a(this,"domainId",""),a(this,"domainName",""),a(this,"endpoint",""),a(this,"projectDomainName",""),a(this,"projectId",""),a(this,"username",""),a(this,"password",""),a(this,"token",""),a(this,"region",""),a(this,"catalog",void 0),a(this,"endpoints",void 0),a(this,"userId",""),a(this,"$dispatch",void 0),a(this,"regionsFromCatalog",[]),e.annotations?Object.keys(e.annotations).forEach(t=>{const o=t.split("/");if(2===o.length&&"viarezo.cattle.io"===o[0]){const a=o[1];this[a]=e.annotations[t]}}):Object.keys(e).forEach(t=>{this[t]=e[t]}),this.$dispatch=t.dispatch}async getToken(){const t=this.endpoint.replace(/^https?:\/\//,""),e="/meta/proxy/"+t,o=e+"/auth/tokens",a={auth:{identity:{methods:["password"],password:{user:{name:this.username,domain:{name:this.domainName},password:this.password}}}}};this.projectId&&(a.auth.scope={project:{id:this.projectId}});const s={Accept:"application/json"};try{var i,r;const t=await this.$dispatch("management/request",{url:o,headers:s,method:"POST",redirectUnauthorized:!1,data:a},{root:!0});if(502===t._status)return{error:"Could not proxy request - URL may not be in Rancher's allow list"};const e=t._headers["x-subject-token"];return this.token=e,this.userId=null===t||void 0===t||null===(i=t.token)||void 0===i||null===(i=i.user)||void 0===i?void 0:i.id,this.domainId=null===t||void 0===t||null===(r=t.token)||void 0===r||null===(r=r.project)||void 0===r||null===(r=r.domain)||void 0===r?void 0:r.id,this.regionsFromCatalog=[],a.auth.scope&&null!==t&&void 0!==t&&t.token&&(this.catalog=t.token.catalog,this.endpoints={},this.catalog.forEach(t=>{const e=t.endpoints.find(t=>"public"===t.interface);e&&e.region_id===this.region&&(this.endpoints[t.type]=e.url),e&&"compute"===t.type&&(this.regionsFromCatalog.includes(e.region_id)||this.regionsFromCatalog.push(e.region_id))})),this.regionsFromCatalog=this.regionsFromCatalog.map(t=>({id:t})),t}catch(n){return console.error(n),{error:n}}}async getFlavors(t,e){return await this.getOptions(t,"/flavors","flavors",void 0,e)}async getImages(t,e){return await this.getOptions(t,"/images/detail","images",void 0,e)}async getKeyPairs(t,e){return await this.getOptions(t,"/os-keypairs","keypairs",t=>t.keypair,e)}async getSecurityGroups(t,e){return await this.getOptions(t,"/os-security-groups","security_groups",void 0,e)}async getFloatingIpPools(t,e){return await this.getOptions(t,"/os-floating-ip-pools","floating_ip_pools",void 0,e)}async getNetworkNames(t,e){return await this.getOptions(t,"/os-tenant-networks","networks",t=>({...t,name:t.label}),e)}async getAvailabilityZones(t,e){return await this.getOptions(t,"/os-availability-zone","availabilityZoneInfo",t=>({...t,name:t.zoneName}),e)}async getOptions(t,e,o,a,s){t.busy=!0,t.enabled=!0,t.selected="";const i=await this.makeComputeRequest(e);if(i&&i[o]){let e=i[o]||[];if(a&&(e=e.map(t=>a(t))),t.options=this.convertToOptions(e),t.busy=!1,s){const e=t.options.find(t=>t.value.id===s);e&&(t.selected=e.value)}!t.selected&&t.options.length>0&&(t.selected=t.options[0].value)}else t.options=[],t.selected=null,t.busy=!1,t.enabled=!1}async makeComputeRequest(t){const e=this.endpoints["compute"].replace(/^https?:\/\//,""),o="/meta/proxy/"+e,a=`${o}${t}`,s={Accept:"application/json","X-Auth-Token":this.token};try{const t=await this.$dispatch("management/request",{url:a,headers:s,method:"GET",redirectUnauthorized:!1},{root:!0});return t}catch(i){console.error(i)}}async getProjects(){const t=this.endpoint.replace(/^https?:\/\//,""),e="/meta/proxy/"+t,o={Accept:"application/json","X-Auth-Token":this.token};try{const t=await this.$dispatch("management/request",{url:`${e}/users/${this.userId}/projects`,headers:o,method:"GET",redirectUnauthorized:!1},{root:!0});return null===t||void 0===t?void 0:t.projects}catch(a){return console.error(a),{error:a}}}async getRegions(){const t=this.endpoint.replace(/^https?:\/\//,""),e="/meta/proxy/"+t,o={Accept:"application/json","X-Auth-Token":this.token};try{const t=await this.$dispatch("management/request",{url:e+"/regions",headers:o,method:"GET",redirectUnauthorized:!1},{root:!0});return null===t||void 0===t?void 0:t.regions}catch(a){return console.error(a),{error:a}}}convertToOptions(t){const e=(t||[]).sort((t,e)=>t.name.localeCompare(e.name));return e.map(t=>({label:t.name,value:t}))}}}}]);
//# sourceMappingURL=node-driver-0.1.1.umd.min.cloud-credential.js.map