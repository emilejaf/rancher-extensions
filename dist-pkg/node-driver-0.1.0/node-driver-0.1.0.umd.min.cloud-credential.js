(("undefined"!==typeof self?self:this)["webpackChunknode_driver_0_1_0"]=("undefined"!==typeof self?self:this)["webpackChunknode_driver_0_1_0"]||[]).push([[916],{4247:function(e,t,o){"use strict";o.d(t,{P:function(){return n}});var a=o(4364);function s(e,t,o){return(t=r(t))in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function r(e){var t=i(e,"string");return"symbol"==typeof t?t:t+""}function i(e,t){if("object"!=typeof e||!e)return e;var o=e[Symbol.toPrimitive];if(void 0!==o){var a=o.call(e,t||"default");if("object"!=typeof a)return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}class n{constructor(e,t){s(this,"domainId",""),s(this,"domainName",""),s(this,"endpoint",""),s(this,"projectDomainName",""),s(this,"projectId",""),s(this,"username",""),s(this,"password",""),s(this,"token",""),s(this,"region",""),s(this,"catalog",void 0),s(this,"endpoints",void 0),s(this,"userId",""),s(this,"$dispatch",void 0),s(this,"regionsFromCatalog",[]),t.annotations?Object.keys(t.annotations).forEach((e=>{const o=e.split("/");if(2===o.length&&"viarezo.cattle.io"===o[0]){const a=o[1];this[a]=t.annotations[e]}})):Object.keys(t).forEach((e=>{this[e]=t[e]})),this.$dispatch=e.dispatch}async getToken(){const e=this.endpoint.replace(/^https?:\/\//,""),t=`/meta/proxy/${e}`,o=`${t}/auth/tokens`,s={auth:{identity:{methods:["password"],password:{user:{name:this.username,domain:{name:this.domainName},password:this.password}}}}};this.projectId&&(s.auth.scope={project:{id:this.projectId}});const r={Accept:"application/json"};try{const e=await this.$dispatch("management/request",{url:o,headers:r,method:"POST",redirectUnauthorized:!1,data:s},{root:!0});if(502===e._status)return{error:"Could not proxy request - URL may not be in Rancher's allow list"};const t=e._headers["x-subject-token"];return this.token=t,this.userId=e?.token?.user?.id,this.domainId=e?.token?.project?.domain?.id,a.log(this.domainId),this.regionsFromCatalog=[],s.auth.scope&&e?.token&&(this.catalog=e.token.catalog,this.endpoints={},this.catalog.forEach((e=>{const t=e.endpoints.find((e=>"public"===e.interface));t&&t.region_id===this.region&&(this.endpoints[e.type]=t.url),t&&"compute"===e.type&&(this.regionsFromCatalog.includes(t.region_id)||this.regionsFromCatalog.push(t.region_id))}))),this.regionsFromCatalog=this.regionsFromCatalog.map((e=>({id:e}))),e}catch(i){return a.error(i),{error:i}}}async getFlavors(e,t){return await this.getOptions(e,"/flavors","flavors",void 0,t)}async getImages(e,t){return await this.getOptions(e,"/images/detail","images",void 0,t)}async getKeyPairs(e,t){return await this.getOptions(e,"/os-keypairs","keypairs",(e=>e.keypair),t)}async getSecurityGroups(e,t){return await this.getOptions(e,"/os-security-groups","security_groups",void 0,t)}async getFloatingIpPools(e,t){return await this.getOptions(e,"/os-floating-ip-pools","floating_ip_pools",void 0,t)}async getNetworkNames(e,t){return await this.getOptions(e,"/os-tenant-networks","networks",(e=>({...e,name:e.label})),t)}async getAvailabilityZones(e,t){return await this.getOptions(e,"/os-availability-zone","availabilityZoneInfo",(e=>({...e,name:e.zoneName})),t)}async getOptions(e,t,o,a,s){e.busy=!0,e.enabled=!0,e.selected="";const r=await this.makeComputeRequest(t);if(r&&r[o]){let t=r[o]||[];if(a&&(t=t.map((e=>a(e)))),e.options=this.convertToOptions(t),e.busy=!1,s){const t=e.options.find((e=>e.value.id===s));t&&(e.selected=t.value)}!e.selected&&e.options.length>0&&(e.selected=e.options[0].value)}else e.options=[],e.selected=null,e.busy=!1,e.enabled=!1}async makeComputeRequest(e){const t=this.endpoints["compute"].replace(/^https?:\/\//,""),o=`/meta/proxy/${t}`,s=`${o}${e}`,r={Accept:"application/json","X-Auth-Token":this.token};try{const e=await this.$dispatch("management/request",{url:s,headers:r,method:"GET",redirectUnauthorized:!1},{root:!0});return e}catch(i){a.error(i)}}async getProjects(){const e=this.endpoint.replace(/^https?:\/\//,""),t=`/meta/proxy/${e}`,o={Accept:"application/json","X-Auth-Token":this.token};try{const e=await this.$dispatch("management/request",{url:`${t}/users/${this.userId}/projects`,headers:o,method:"GET",redirectUnauthorized:!1},{root:!0});return e?.projects}catch(s){return a.error(s),{error:s}}}async getRegions(){const e=this.endpoint.replace(/^https?:\/\//,""),t=`/meta/proxy/${e}`,o={Accept:"application/json","X-Auth-Token":this.token};try{const e=await this.$dispatch("management/request",{url:`${t}/regions`,headers:o,method:"GET",redirectUnauthorized:!1},{root:!0});return e?.regions}catch(s){return a.error(s),{error:s}}}convertToOptions(e){const t=(e||[]).sort(((e,t)=>e.name.localeCompare(t.name)));return t.map((e=>({label:e.name,value:e})))}}},6844:function(e,t,o){"use strict";o.r(t),o.d(t,{default:function(){return O}});var a=o(9274);const s={class:"row"},r={class:"col span-6"},i={class:"col span-6"},n={class:"row"},l={class:"col span-6"},d={class:"col span-6"},c=["disabled"],u=["disabled"],p={key:2,class:"row mt-20"},h={class:"col span-6"},m={key:0,class:"col span-6"};function v(e,t,o,v,y,g){const f=(0,a.resolveComponent)("LabeledInput"),b=(0,a.resolveComponent)("BusyButton"),w=(0,a.resolveComponent)("Banner"),k=(0,a.resolveComponent)("LabeledSelect");return(0,a.openBlock)(),(0,a.createElementBlock)("div",null,[(0,a.createElementVNode)("div",s,[(0,a.createElementVNode)("div",r,[(0,a.createVNode)(f,{value:o.value.decodedData.endpoint,disabled:1!==y.step,"label-key":"driver.viarezo.auth.fields.endpoint","placeholder-key":"driver.viarezo.auth.placeholders.endpoint",type:"text",mode:o.mode,onInput:t[0]||(t[0]=e=>o.value.setData("endpoint",e.target.value))},null,8,["value","disabled","mode"])]),(0,a.createElementVNode)("div",i,[(0,a.createVNode)(f,{value:o.value.decodedData.domainName,disabled:1!==y.step,"label-key":"driver.viarezo.auth.fields.domainName","placeholder-key":"driver.viarezo.auth.placeholders.domainName",type:"text",mode:o.mode,onInput:t[1]||(t[1]=e=>{o.value.setData("domainName",e.target.value)})},null,8,["value","disabled","mode"])])]),(0,a.createElementVNode)("div",n,[(0,a.createElementVNode)("div",l,[(0,a.createVNode)(f,{value:o.value.decodedData.username,disabled:1!==y.step,class:"mt-20","label-key":"driver.viarezo.auth.fields.username","placeholder-key":"driver.viarezo.auth.placeholders.username",type:"text",mode:o.mode,onInput:t[2]||(t[2]=e=>{o.value.setData("username",e.target.value)})},null,8,["value","disabled","mode"])]),(0,a.createElementVNode)("div",d,[(0,a.createVNode)(f,{value:o.value.decodedData.password,disabled:1!==y.step,class:"mt-20","label-key":"driver.viarezo.auth.fields.password","placeholder-key":"driver.viarezo.auth.placeholders.password",type:"password",mode:o.mode,onInput:t[3]||(t[3]=e=>{o.value.setData("password",e.target.value)})},null,8,["value","disabled","mode"])])]),(0,a.createVNode)(b,{ref:"connect","label-key":"driver.viarezo.auth.actions.authenticate",disabled:1!==y.step||!g.canAuthenticate,class:"mt-20",onClick:g.connect},null,8,["disabled","onClick"]),(0,a.createElementVNode)("button",{class:"btn role-primary mt-20 ml-20",disabled:y.busy||1===y.step,onClick:t[4]||(t[4]=(...e)=>g.clear&&g.clear(...e))},(0,a.toDisplayString)(e.t("driver.viarezo.auth.actions.edit")),9,c),y.error?((0,a.openBlock)(),(0,a.createBlock)(w,{key:0,class:"mt-20",color:"error"},{default:(0,a.withCtx)((()=>[(0,a.createTextVNode)((0,a.toDisplayString)(y.error),1)])),_:1})):(0,a.createCommentVNode)("",!0),y.errorAllowHost?((0,a.openBlock)(),(0,a.createBlock)(w,{key:1,color:"error",class:"allow-list-error"},{default:(0,a.withCtx)((()=>[(0,a.createElementVNode)("div",null,(0,a.toDisplayString)(e.t("driver.viarezo.auth.errors.notAllowed",{hostname:g.hostname})),1),(0,a.createElementVNode)("button",{disabled:y.allowBusy,class:"btn ml-10 role-primary",onClick:t[5]||(t[5]=(...e)=>g.addHostToAllowList&&g.addHostToAllowList(...e))},(0,a.toDisplayString)(e.t("driver.viarezo.auth.actions.addToAllowList")),9,u)])),_:1})):(0,a.createCommentVNode)("",!0),y.projects?((0,a.openBlock)(),(0,a.createElementBlock)("div",p,[(0,a.createElementVNode)("div",h,[(0,a.createVNode)(k,{value:y.project,"onUpdate:value":t[6]||(t[6]=e=>y.project=e),"label-key":"driver.viarezo.auth.fields.project",options:g.projectOptions,searchable:!1},null,8,["value","options"])]),y.regions?((0,a.openBlock)(),(0,a.createElementBlock)("div",m,[(0,a.createVNode)(k,{value:y.region,"onUpdate:value":t[7]||(t[7]=e=>y.region=e),"label-key":"driver.viarezo.auth.fields.region",options:g.regionOptions,searchable:!1},null,8,["value","options"])])):(0,a.createCommentVNode)("",!0)])):(0,a.createCommentVNode)("",!0)])}var y=o(8023),g=o(1419),f=o(3527);o(5664);function b(e){const t=b.options,o=t.parser[t.strictMode?"strict":"loose"].exec(e);if(!o)throw new Error(`Cannot parse as uri: ${e}`);const a={};let s=14;while(s--)a[t.key[s]]=o[s]||"";return a.query={},a.queryStr.replace(t.q.parser,((e,o,s)=>(o&&(a[t.q.name][o]=s),""))),a}b.options={strictMode:!1,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","queryStr","anchor"],q:{name:"query",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}};var w=o(4220);const k=e=>((0,a.pushScopeId)("data-v-057271d0"),e=e(),(0,a.popScopeId)(),e),j=["disabled","tab-index","data-testid"],N={key:0,class:"icon icon-lg icon-spinner icon-spin"},D={key:1,class:"icon-spacer"},C=k((()=>(0,a.createElementVNode)("span",{class:"icon-spacer"},null,-1)));function z(e,t,o,s,r,i){return(0,a.openBlock)(),(0,a.createElementBlock)("button",{ref:"btn",class:"btn role-primary",disabled:o.disabled,"tab-index":o.tabIndex,"data-testid":o.componentTestid+"-async-button",onClick:t[0]||(t[0]=(...e)=>i.clicked&&i.clicked(...e))},[r.busy?((0,a.openBlock)(),(0,a.createElementBlock)("i",N)):((0,a.openBlock)(),(0,a.createElementBlock)("span",D)),(0,a.createElementVNode)("span",null,(0,a.toDisplayString)(i.displayLabel),1),C],8,j)}var I={props:{label:{type:String,default:void 0},labelKey:{type:String,default:void 0},disabled:{type:Boolean,default:!1},tabIndex:{type:Number,default:null},componentTestid:{type:String,default:"busy-button"},manual:{type:Boolean,default:!1}},data(){return{busy:!1}},computed:{displayLabel(){if(this.labelKey){const e=this.$store.getters["i18n/t"];return e(this.labelKey)}return this.label}},methods:{clicked(e){if(e&&(e.stopPropagation(),e.preventDefault()),this.disabled)return;const t=()=>{this.busy=!1};this.busy=!0,this.$emit("click",t)},focus(){this.$refs.btn.focus()}}},_=(o(1735),o(7433));const A=(0,_.A)(I,[["render",z],["__scopeId","data-v-057271d0"]]);var B=A,$=o(4247),E=o(4364),V={components:{Banner:y.A,BusyButton:B,LabeledInput:g.o,LabeledSelect:f.A},props:{mode:{type:String,required:!0},value:{type:Object,required:!0}},async fetch(){this.driver=await this.$store.dispatch("rancher/find",{type:"nodedriver",id:"viarezo"})},data(){return this.mode!==w.YQ&&(this.value.decodedData.username=this.value.annotations["viarezo.cattle.io/username"],this.value.decodedData.endpoint=this.value.annotations["viarezo.cattle.io/endpoint"]),{projects:null,regions:null,step:1,busy:!1,project:"",region:"",errorAllowHost:!1,driver:{},allowBusy:!1,error:""}},computed:{projectOptions(){const e=(this.projects||[]).sort(((e,t)=>e.name.localeCompare(t.name)));return e.map((e=>({label:e.name,value:e.id})))},regionOptions(){const e=(this.regions||[]).sort(((e,t)=>e.name.localeCompare(t.name)));return e.map((e=>({label:e.id,value:e.id})))},hostname(){const e=b(this.value.decodedData.endpoint);return e?.host||""},canAuthenticate(){return!!this.value?.decodedData?.endpoint&&!!this.value?.decodedData?.domainName&&!!this.value?.decodedData?.username&&!!this.value?.decodedData?.password}},created(){this.$emit("validationChanged",!1)},methods:{test(){this.value.annotations=this.value.annotations||{},this.value.annotations["viarezo.cattle.io/username"]=this.value.decodedData.username,this.value.annotations["viarezo.cattle.io/domainName"]=this.value.decodedData.domainName,this.value.annotations["viarezo.cattle.io/endpoint"]=this.value.decodedData.endpoint;const e=this.projects.find((e=>e.id===this.project));return e&&(this.value.annotations["viarezo.cattle.io/projectId"]=e.id),this.region&&(this.value.annotations["viarezo.cattle.io/region"]=this.region),!0},clear(){this.step=1,this.projects=null,this.errorAllowHost=!1,this.$emit("validationChanged",!1)},hostInAllowList(){if(!this.driver?.whitelistDomains)return!1;const e=b(this.value.decodedData.endpoint);return!e.host||(this.driver?.whitelistDomains||[]).includes(e.host)},async addHostToAllowList(){this.allowBusy=!0;const e=b(this.value.decodedData.endpoint);this.driver.whitelistDomains=this.driver.whitelistDomains||[],this.hostInAllowList()||this.driver.whitelistDomains.push(e.host);try{await this.driver.save(),this.$refs.connect.$el.click()}catch(t){E.error("Could not update driver",t),this.allowBusy=!1}},async connect(e){if(e&&"function"!==typeof e)return;this.error="",this.errorAllowHost=!1;let t=!1;if(!this.value.decodedData.endpoint)return e(t);const o=new $.P(this.$store,{endpoint:this.value.decodedData.endpoint,domainName:this.value.decodedData.domainName,username:this.value.decodedData.username,password:this.value.decodedData.password});this.allowBusy=!1,this.step=2,this.busy=!0;const a=await o.getToken();if(a.error)E.error(a.error),t=!1,this.step=1,this.projects=null,502!==a.error._status||this.hostInAllowList()?502===a.error._status?this.error=this.t("driver.viarezo.auth.errors.badGateway"):401===a.error._status?this.error=this.t("driver.viarezo.auth.errors.unauthorized"):this.error=a.error.message||this.t("driver.viarezo.auth.errors.other"):this.errorAllowHost=!0;else{const e=await o.getProjects();e.error?this.error=e.error.message:(this.projects=e,t=!0);const a=await o.getRegions();if(a.error){const e=this.projectOptions[0].value,t=this.projects.find((t=>t.id===e));if(t){const e=new $.P(this.$store,{...o,projectName:t.name,projectId:t.id,projectDomainName:t.domain_id});await e.getToken().then((()=>{this.regions=e.regionsFromCatalog}))}}else this.regions=a,t=!0}this.busy=!1,this.project=this.projectOptions[0]?.value,this.region=this.regionOptions[0]?.value,this.$emit("validationChanged",t),e(t)}}};o(3906);const x=(0,_.A)(V,[["render",v],["__scopeId","data-v-72697f28"]]);var O=x},498:function(e,t,o){"use strict";o.r(t);var a=o(6758),s=o.n(a),r=o(6173),i=o.n(r),n=i()(s());n.push([e.id,".allow-list-error[data-v-72697f28]{display:flex}.allow-list-error[data-v-72697f28]>:first-child{flex:1}",""]),t["default"]=n},9879:function(e,t,o){"use strict";o.r(t);var a=o(6758),s=o.n(a),r=o(6173),i=o.n(r),n=i()(s());n.push([e.id,".icon-spacer[data-v-057271d0]{width:24px}",""]),t["default"]=n},3906:function(e,t,o){var a=o(498);a.__esModule&&(a=a.default),"string"===typeof a&&(a=[[e.id,a,""]]),a.locals&&(e.exports=a.locals);var s=o(4825).A;s("442cbbde",a,!0,{sourceMap:!1,shadowMode:!1})},1735:function(e,t,o){var a=o(9879);a.__esModule&&(a=a.default),"string"===typeof a&&(a=[[e.id,a,""]]),a.locals&&(e.exports=a.locals);var s=o(4825).A;s("5b9d9a71",a,!0,{sourceMap:!1,shadowMode:!1})}}]);
//# sourceMappingURL=node-driver-0.1.0.umd.min.cloud-credential.js.map