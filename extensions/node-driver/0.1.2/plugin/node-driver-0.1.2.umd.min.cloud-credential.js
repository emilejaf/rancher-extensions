(("undefined"!==typeof self?self:this)["webpackJsonpnode_driver_0_1_2"]=("undefined"!==typeof self?self:this)["webpackJsonpnode_driver_0_1_2"]||[]).push([[1],{"64ed":function(e,t,a){var o=a("3c10");t=o(!1),t.push([e.i,".allow-list-error[data-v-5503c3ae]{display:flex}.allow-list-error[data-v-5503c3ae]>:first-child{flex:1}",""]),e.exports=t},"955e":function(e,t,a){var o=a("64ed");o.__esModule&&(o=o.default),"string"===typeof o&&(o=[[e.i,o,""]]),o.locals&&(e.exports=o.locals);var s=a("0ed3").default;s("0b46f0df",o,!0,{sourceMap:!1,shadowMode:!1})},"9c1a":function(e,t,a){"use strict";a("955e")},"9c5d":function(e,t,a){var o=a("3c10");t=o(!1),t.push([e.i,".icon-spacer[data-v-057271d0]{width:24px}",""]),e.exports=t},c990:function(e,t,a){var o=a("9c5d");o.__esModule&&(o=o.default),"string"===typeof o&&(o=[[e.i,o,""]]),o.locals&&(e.exports=o.locals);var s=a("0ed3").default;s("1d62ab36",o,!0,{sourceMap:!1,shadowMode:!1})},cd48:function(e,t,a){"use strict";a.r(t);var o=function(){var e=this,t=e._self._c;return t("div",[t("div",{staticClass:"row"},[t("div",{staticClass:"col span-6"},[t("LabeledInput",{attrs:{value:e.value.decodedData.endpoint,disabled:1!==e.step,"label-key":"driver.viarezo.auth.fields.endpoint","placeholder-key":"driver.viarezo.auth.placeholders.endpoint",type:"text",mode:e.mode},on:{input:function(t){return e.value.setData("endpoint",t)}}})],1),t("div",{staticClass:"col span-6"},[t("LabeledInput",{attrs:{value:e.value.decodedData.domainName,disabled:1!==e.step,"label-key":"driver.viarezo.auth.fields.domainName","placeholder-key":"driver.viarezo.auth.placeholders.domainName",type:"text",mode:e.mode},on:{input:function(t){return e.value.setData("domainName",t)}}})],1)]),t("div",{staticClass:"row"},[t("div",{staticClass:"col span-6"},[t("LabeledInput",{staticClass:"mt-20",attrs:{value:e.value.decodedData.username,disabled:1!==e.step,"label-key":"driver.viarezo.auth.fields.username","placeholder-key":"driver.viarezo.auth.placeholders.username",type:"text",mode:e.mode},on:{input:function(t){return e.value.setData("username",t)}}})],1),t("div",{staticClass:"col span-6"},[t("LabeledInput",{staticClass:"mt-20",attrs:{value:e.value.decodedData.password,disabled:1!==e.step,"label-key":"driver.viarezo.auth.fields.password","placeholder-key":"driver.viarezo.auth.placeholders.password",type:"password",mode:e.mode},on:{input:function(t){return e.value.setData("password",t)}}})],1)]),t("BusyButton",{ref:"connect",staticClass:"mt-20",attrs:{"label-key":"driver.viarezo.auth.actions.authenticate",disabled:1!==e.step||!e.canAuthenticate},on:{click:e.connect}}),t("button",{staticClass:"btn role-primary mt-20 ml-20",attrs:{disabled:e.busy||1===e.step},on:{click:e.clear}},[e._v(" "+e._s(e.t("driver.viarezo.auth.actions.edit"))+" ")]),e.error?t("Banner",{staticClass:"mt-20",attrs:{color:"error"}},[e._v(" "+e._s(e.error)+" ")]):e._e(),e.errorAllowHost?t("Banner",{staticClass:"allow-list-error",attrs:{color:"error"}},[t("div",[e._v(" "+e._s(e.t("driver.viarezo.auth.errors.notAllowed",{hostname:e.hostname}))+" ")]),t("button",{staticClass:"btn ml-10 role-primary",attrs:{disabled:e.allowBusy},on:{click:e.addHostToAllowList}},[e._v(" "+e._s(e.t("driver.viarezo.auth.actions.addToAllowList"))+" ")])]):e._e(),e.projects?t("div",{staticClass:"row mt-20"},[t("div",{staticClass:"col span-6"},[t("LabeledSelect",{attrs:{value:e.project,"label-key":"driver.viarezo.auth.fields.project",options:e.projectOptions,searchable:!1},on:{"update:value":t=>e.project=t}})],1),e.regions?t("div",{staticClass:"col span-6"},[t("LabeledSelect",{attrs:{value:e.region,"label-key":"driver.viarezo.auth.fields.region",options:e.regionOptions,searchable:!1},on:{"update:value":t=>e.region=t}})],1):e._e()]):e._e()],1)},s=[],i=a("eb32"),r=a("8e93"),n=a("466b");a("907c");function l(e){const t=l.options,a=t.parser[t.strictMode?"strict":"loose"].exec(e);if(!a)throw new Error("Cannot parse as uri: "+e);const o={};let s=14;while(s--)o[t.key[s]]=a[s]||"";return o.query={},o.queryStr.replace(t.q.parser,(e,a,s)=>(a&&(o[t.q.name][a]=s),"")),o}l.options={strictMode:!1,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","queryStr","anchor"],q:{name:"query",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}};var d=a("da25"),c=function(){var e=this,t=e._self._c;return t("button",{ref:"btn",staticClass:"btn role-primary",attrs:{disabled:e.disabled,"tab-index":e.tabIndex,"data-testid":e.componentTestid+"-async-button"},on:{click:e.clicked}},[e.busy?t("i",{staticClass:"icon icon-lg icon-spinner icon-spin"}):t("span",{staticClass:"icon-spacer"}),t("span",[e._v(e._s(e.displayLabel))]),t("span",{staticClass:"icon-spacer"})])},u=[],p={props:{label:{type:String,default:void 0},labelKey:{type:String,default:void 0},disabled:{type:Boolean,default:!1},tabIndex:{type:Number,default:null},componentTestid:{type:String,default:"busy-button"},manual:{type:Boolean,default:!1}},data(){return{busy:!1}},computed:{displayLabel(){if(this.labelKey){const e=this.$store.getters["i18n/t"];return e(this.labelKey)}return this.label}},methods:{clicked(e){if(e&&(e.stopPropagation(),e.preventDefault()),this.disabled)return;const t=()=>{this.busy=!1};this.busy=!0,this.$emit("click",t)},focus(){this.$refs.btn.focus()}}},h=p,v=(a("dcb6"),a("2be6")),m=Object(v["a"])(h,c,u,!1,null,"057271d0",null),y=m.exports,f=a("f2d8"),g={components:{Banner:i["a"],BusyButton:y,LabeledInput:r["a"],LabeledSelect:n["a"]},props:{mode:{type:String,required:!0},value:{type:Object,required:!0}},async fetch(){this.driver=await this.$store.dispatch("rancher/find",{type:"nodedriver",id:"viarezo"})},data(){return this.mode!==d["a"]&&(this.value.decodedData.username=this.value.annotations["viarezo.cattle.io/username"],this.value.decodedData.endpoint=this.value.annotations["viarezo.cattle.io/endpoint"],this.value.decodedData.domainName=this.value.annotations["viarezo.cattle.io/domainName"]),{projects:null,regions:null,step:1,busy:!1,project:"",region:"",errorAllowHost:!1,driver:{},allowBusy:!1,error:""}},computed:{projectOptions(){const e=(this.projects||[]).sort((e,t)=>e.name.localeCompare(t.name));return e.map(e=>({label:e.name,value:e.id}))},regionOptions(){const e=(this.regions||[]).sort((e,t)=>e.name.localeCompare(t.name));return e.map(e=>({label:e.id,value:e.id}))},hostname(){const e=l(this.value.decodedData.endpoint);return(null===e||void 0===e?void 0:e.host)||""},canAuthenticate(){var e,t,a,o;return!(null===(e=this.value)||void 0===e||null===(e=e.decodedData)||void 0===e||!e.endpoint)&&!(null===(t=this.value)||void 0===t||null===(t=t.decodedData)||void 0===t||!t.domainName)&&!(null===(a=this.value)||void 0===a||null===(a=a.decodedData)||void 0===a||!a.username)&&!(null===(o=this.value)||void 0===o||null===(o=o.decodedData)||void 0===o||!o.password)}},created(){this.$emit("validationChanged",!1)},methods:{test(){this.value.annotations=this.value.annotations||{},this.value.annotations["viarezo.cattle.io/username"]=this.value.decodedData.username,this.value.annotations["viarezo.cattle.io/domainName"]=this.value.decodedData.domainName,this.value.annotations["viarezo.cattle.io/endpoint"]=this.value.decodedData.endpoint;const e=this.projects.find(e=>e.id===this.project);return e&&(this.value.annotations["viarezo.cattle.io/projectId"]=e.id),this.region&&(this.value.annotations["viarezo.cattle.io/region"]=this.region),!0},clear(){this.step=1,this.projects=null,this.errorAllowHost=!1,this.$emit("validationChanged",!1)},hostInAllowList(){var e,t;if(null===(e=this.driver)||void 0===e||!e.whitelistDomains)return!1;const a=l(this.value.decodedData.endpoint);return!a.host||((null===(t=this.driver)||void 0===t?void 0:t.whitelistDomains)||[]).includes(a.host)},async addHostToAllowList(){this.allowBusy=!0;const e=l(this.value.decodedData.endpoint);this.driver.whitelistDomains=this.driver.whitelistDomains||[],this.hostInAllowList()||this.driver.whitelistDomains.push(e.host);try{await this.driver.save(),this.$refs.connect.$el.click()}catch(t){console.error("Could not update driver",t),this.allowBusy=!1}},async connect(e){var t,a;if(e&&"function"!==typeof e)return;this.error="",this.errorAllowHost=!1;let o=!1;if(!this.value.decodedData.endpoint)return e(o);const s=new f["a"](this.$store,{endpoint:this.value.decodedData.endpoint,domainName:this.value.decodedData.domainName,username:this.value.decodedData.username,password:this.value.decodedData.password});this.allowBusy=!1,this.step=2,this.busy=!0;const i=await s.getToken();if(i.error)console.error(i.error),o=!1,this.step=1,this.projects=null,502!==i.error._status||this.hostInAllowList()?502===i.error._status?this.error=this.t("driver.viarezo.auth.errors.badGateway"):401===i.error._status?this.error=this.t("driver.viarezo.auth.errors.unauthorized"):this.error=i.error.message||this.t("driver.viarezo.auth.errors.other"):this.errorAllowHost=!0;else{const e=await s.getProjects();e.error?this.error=e.error.message:(this.projects=e,o=!0);const t=await s.getRegions();if(t.error){const e=this.projectOptions[0].value,t=this.projects.find(t=>t.id===e);if(t){const e=new f["a"](this.$store,{...s,projectName:t.name,projectId:t.id,projectDomainName:t.domain_id});await e.getToken().then(()=>{this.regions=e.regionsFromCatalog})}}else this.regions=t,o=!0}this.busy=!1,this.project=null===(t=this.projectOptions[0])||void 0===t?void 0:t.value,this.region=null===(a=this.regionOptions[0])||void 0===a?void 0:a.value,this.$emit("validationChanged",o),e(o)}}},b=g,w=(a("9c1a"),Object(v["a"])(b,o,s,!1,null,"5503c3ae",null));t["default"]=w.exports},dcb6:function(e,t,a){"use strict";a("c990")},f2d8:function(e,t,a){"use strict";function o(e,t,a){return(t=s(t))in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function s(e){var t=i(e,"string");return"symbol"==typeof t?t:t+""}function i(e,t){if("object"!=typeof e||!e)return e;var a=e[Symbol.toPrimitive];if(void 0!==a){var o=a.call(e,t||"default");if("object"!=typeof o)return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}a.d(t,"a",(function(){return r}));class r{constructor(e,t){o(this,"domainId",""),o(this,"domainName",""),o(this,"endpoint",""),o(this,"projectDomainName",""),o(this,"projectId",""),o(this,"username",""),o(this,"password",""),o(this,"token",""),o(this,"region",""),o(this,"catalog",void 0),o(this,"endpoints",void 0),o(this,"userId",""),o(this,"$dispatch",void 0),o(this,"regionsFromCatalog",[]),t.annotations?Object.keys(t.annotations).forEach(e=>{const a=e.split("/");if(2===a.length&&"viarezo.cattle.io"===a[0]){const o=a[1];this[o]=t.annotations[e]}}):Object.keys(t).forEach(e=>{this[e]=t[e]}),this.$dispatch=e.dispatch}async getToken(){const e=this.endpoint.replace(/^https?:\/\//,""),t="/meta/proxy/"+e,a=t+"/auth/tokens",o={auth:{identity:{methods:["password"],password:{user:{name:this.username,domain:{name:this.domainName},password:this.password}}}}};this.projectId&&(o.auth.scope={project:{id:this.projectId}});const s={Accept:"application/json"};try{var i,r;const e=await this.$dispatch("management/request",{url:a,headers:s,method:"POST",redirectUnauthorized:!1,data:o},{root:!0});if(502===e._status)return{error:"Could not proxy request - URL may not be in Rancher's allow list"};const t=e._headers["x-subject-token"];return this.token=t,this.userId=null===e||void 0===e||null===(i=e.token)||void 0===i||null===(i=i.user)||void 0===i?void 0:i.id,this.domainId=null===e||void 0===e||null===(r=e.token)||void 0===r||null===(r=r.project)||void 0===r||null===(r=r.domain)||void 0===r?void 0:r.id,this.regionsFromCatalog=[],o.auth.scope&&null!==e&&void 0!==e&&e.token&&(this.catalog=e.token.catalog,this.endpoints={},this.catalog.forEach(e=>{const t=e.endpoints.find(e=>"public"===e.interface);t&&t.region_id===this.region&&(this.endpoints[e.type]=t.url),t&&"compute"===e.type&&(this.regionsFromCatalog.includes(t.region_id)||this.regionsFromCatalog.push(t.region_id))})),this.regionsFromCatalog=this.regionsFromCatalog.map(e=>({id:e})),e}catch(n){return console.error(n),{error:n}}}async getFlavors(e,t){return await this.getOptions(e,"/flavors","flavors",void 0,t)}async getImages(e,t){return await this.getOptions(e,"/images/detail","images",void 0,t)}async getKeyPairs(e,t){return await this.getOptions(e,"/os-keypairs","keypairs",e=>e.keypair,t)}async getSecurityGroups(e,t){return await this.getOptions(e,"/os-security-groups","security_groups",void 0,t,"name")}async getFloatingIpPools(e,t){return await this.getOptions(e,"/os-floating-ip-pools","floating_ip_pools",void 0,t)}async getNetworkNames(e,t){return await this.getOptions(e,"/os-tenant-networks","networks",e=>({...e,name:e.label}),t)}async getAvailabilityZones(e,t){return await this.getOptions(e,"/os-availability-zone","availabilityZoneInfo",e=>({...e,name:e.zoneName}),t)}async getOptions(e,t,a,o,s,i){e.busy=!0,e.enabled=!0,e.selected="";const r=await this.makeComputeRequest(t);if(r&&r[a]){let t=r[a]||[];if(o&&(t=t.map(e=>o(e))),e.options=this.convertToOptions(t),e.busy=!1,s){const t=i||"id",a=e.options.find(e=>e.value[t]===s);a&&(e.selected=a.value)}!e.selected&&e.options.length>0&&(e.selected=e.options[0].value)}else e.options=[],e.selected=null,e.busy=!1,e.enabled=!1}async makeComputeRequest(e){const t=this.endpoints["compute"].replace(/^https?:\/\//,""),a="/meta/proxy/"+t,o=`${a}${e}`,s={Accept:"application/json","X-Auth-Token":this.token};try{const e=await this.$dispatch("management/request",{url:o,headers:s,method:"GET",redirectUnauthorized:!1},{root:!0});return e}catch(i){console.error(i)}}async getProjects(){const e=this.endpoint.replace(/^https?:\/\//,""),t="/meta/proxy/"+e,a={Accept:"application/json","X-Auth-Token":this.token};try{const e=await this.$dispatch("management/request",{url:`${t}/users/${this.userId}/projects`,headers:a,method:"GET",redirectUnauthorized:!1},{root:!0});return null===e||void 0===e?void 0:e.projects}catch(o){return console.error(o),{error:o}}}async getRegions(){const e=this.endpoint.replace(/^https?:\/\//,""),t="/meta/proxy/"+e,a={Accept:"application/json","X-Auth-Token":this.token};try{const e=await this.$dispatch("management/request",{url:t+"/regions",headers:a,method:"GET",redirectUnauthorized:!1},{root:!0});return null===e||void 0===e?void 0:e.regions}catch(o){return console.error(o),{error:o}}}convertToOptions(e){const t=(e||[]).sort((e,t)=>e.name.localeCompare(t.name));return t.map(e=>({label:e.name,value:e}))}}}}]);
//# sourceMappingURL=node-driver-0.1.2.umd.min.cloud-credential.js.map